generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organisation {
  id               String            @id @default(uuid())
  name             String
  description      String?
  logoUrl          String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  displays         Display[]
  eventTags        EventTag[]
  events           Event[]
  invitations      Invitation[]
  scheduleItemTags ScheduleItemTag[]
  users            User[]

  @@map("organisations")
}

model Event {
  id              String            @id @default(uuid())
  name            String
  description     String?
  organisationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  EventToEventTag EventToEventTag[]
  dayPlans        DayPlan[]
  organisation    Organisation      @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@map("events")
}

model DayPlan {
  id            String         @id @default(uuid())
  eventId       String
  name          String
  date          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  event         Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  scheduleItems ScheduleItem[]

  @@map("day_plans")
}

model ScheduleItem {
  id                            Int                             @id @default(autoincrement())
  dayPlanId                     String
  time                          String
  type                          ScheduleItemType
  title                         String
  speaker                       String?
  location                      String?
  details                       String?
  materials                     String?
  duration                      String?
  snacks                        String?
  facilitator                   String?
  timeChanged                   Boolean?                        @default(false)
  positionChanged               Boolean?                        @default(false)
  originalTime                  String?
  originalPosition              Int?
  position                      Int                             @default(0)
  createdAt                     DateTime                        @default(now())
  updatedAt                     DateTime                        @updatedAt
  delay                         Int?
  ScheduleItemToScheduleItemTag ScheduleItemToScheduleItemTag[]
  dayPlan                       DayPlan                         @relation(fields: [dayPlanId], references: [id], onDelete: Cascade)

  @@index([dayPlanId, position])
  @@map("schedule_items")
}

model AdminUser {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String
  email        String?  @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("admin_users")
}

model User {
  id                     String       @id @default(uuid())
  organisationId         String
  username               String
  email                  String
  passwordHash           String
  role                   UserRole     @default(member)
  emailVerified          Boolean      @default(false)
  emailVerificationToken String?      @unique
  tokenExpiresAt         DateTime?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  sessions               Session[]
  organisation           Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, username])
  @@unique([organisationId, email])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Invitation {
  id             String       @id @default(uuid())
  organisationId String
  email          String
  role           UserRole     @default(member)
  token          String       @unique
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  invitedBy      String
  organisation   Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, email])
  @@map("invitations")
}

model EventTag {
  id              String            @id @default(uuid())
  name            String
  color           String            @default("#64748b")
  organisationId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  EventToEventTag EventToEventTag[]
  organisation    Organisation      @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, name])
  @@map("event_tags")
}

model ScheduleItemTag {
  id                            String                          @id @default(uuid())
  name                          String
  color                         String                          @default("#64748b")
  organisationId                String
  createdAt                     DateTime                        @default(now())
  updatedAt                     DateTime                        @updatedAt
  ScheduleItemToScheduleItemTag ScheduleItemToScheduleItemTag[]
  organisation                  Organisation                    @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@unique([organisationId, name])
  @@map("schedule_item_tags")
}

model Display {
  id               String        @id @default(uuid())
  organisationId   String?
  name             String
  registrationCode String?       @unique
  codeExpiresAt    DateTime?
  isActive         Boolean       @default(false)
  currentDayPlanId String?
  lastSeenAt       DateTime      @default(now())
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  pairingCode      String?       @unique
  socketId         String?
  status           DeviceStatus  @default(PENDING)
  organisation     Organisation? @relation(fields: [organisationId], references: [id], onDelete: Cascade)

  @@map("displays")
}

model EventToEventTag {
  A          String
  B          String
  events     Event    @relation(fields: [A], references: [id], onDelete: Cascade)
  event_tags EventTag @relation(fields: [B], references: [id], onDelete: Cascade)

  @@id([A, B], map: "_EventToEventTag_AB_pkey")
  @@index([B], map: "_EventToEventTag_B_index")
  @@map("_EventToEventTag")
}

model ScheduleItemToScheduleItemTag {
  A                  Int
  B                  String
  schedule_items     ScheduleItem    @relation(fields: [A], references: [id], onDelete: Cascade)
  schedule_item_tags ScheduleItemTag @relation(fields: [B], references: [id], onDelete: Cascade)

  @@id([A, B], map: "_ScheduleItemToScheduleItemTag_AB_pkey")
  @@index([B], map: "_ScheduleItemToScheduleItemTag_B_index")
  @@map("_ScheduleItemToScheduleItemTag")
}

enum ScheduleItemType {
  session
  workshop
  break
  announcement
  game
  transition
}

enum UserRole {
  admin
  member
}

enum DeviceStatus {
  PENDING
  PAIRED
  ACTIVE
}
